# Live Session Management Architecture

Real-time gameplay session tracking with therapist live view.

```
Architecture Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.AUTH  â”‚ â†’ â”‚ 2.START â”‚ â†’ â”‚ 3.TRACK â”‚ â†’ â”‚4.BROADCASTâ”‚ â†’ â”‚ 5.PERSIST  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     THERAPIST LIVE VIEW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 0. DATABASE SCHEMA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE TABLES                              â”‚
â”‚                                                                      â”‚
â”‚  gameplay_sessions                     session_responses             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ id (PK)                        â”‚   â”‚ id (PK)                    â”‚â”‚
â”‚  â”‚ child_id (FK â†’ children)       â”‚   â”‚ session_id (FK)            â”‚â”‚
â”‚  â”‚ therapist_id (FK â†’ therapists) â”‚   â”‚ card_category              â”‚â”‚
â”‚  â”‚ started_at                     â”‚   â”‚ card_question              â”‚â”‚
â”‚  â”‚ ended_at                       â”‚   â”‚ child_response             â”‚â”‚
â”‚  â”‚ duration_seconds               â”‚   â”‚ is_correct (0/1)           â”‚â”‚
â”‚  â”‚ categories_selected (JSON)     â”‚   â”‚ attempt_number             â”‚â”‚
â”‚  â”‚ theme                          â”‚   â”‚ card_shown_at              â”‚â”‚
â”‚  â”‚ character                      â”‚   â”‚ response_at                â”‚â”‚
â”‚  â”‚ status (in_progress/completed/ â”‚   â”‚ time_spent_seconds         â”‚â”‚
â”‚  â”‚         abandoned)             â”‚   â”‚ safety_level               â”‚â”‚
â”‚  â”‚ final_score                    â”‚   â”‚ signals_detected (JSON)    â”‚â”‚
â”‚  â”‚ final_board_position           â”‚   â”‚ intervention_chosen        â”‚â”‚
â”‚  â”‚ total_cards_played             â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”‚ correct_responses              â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                      â”‚
â”‚  voice_calibrations                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚ id (PK)                        â”‚                                  â”‚
â”‚  â”‚ child_id (FK, UNIQUE)          â”‚                                  â”‚
â”‚  â”‚ amplitude_threshold            â”‚                                  â”‚
â”‚  â”‚ peak_threshold                 â”‚                                  â”‚
â”‚  â”‚ baseline_amplitude/peak        â”‚                                  â”‚
â”‚  â”‚ excited_amplitude/peak         â”‚                                  â”‚
â”‚  â”‚ loud_amplitude/peak            â”‚                                  â”‚
â”‚  â”‚ confidence (high/medium/low)   â”‚                                  â”‚
â”‚  â”‚ calibrated_at                  â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                      â”‚
â”‚  INDEXES:                                                            â”‚
â”‚  â€¢ idx_sessions_therapist (therapist_id, started_at DESC)           â”‚
â”‚  â€¢ idx_sessions_child (child_id, started_at DESC)                   â”‚
â”‚  â€¢ idx_sessions_status (status)                                     â”‚
â”‚  â€¢ idx_responses_session (session_id, card_shown_at)                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. AUTHENTICATION - Child Login Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CHILD AUTHENTICATION                            â”‚
â”‚                                                                      â”‚
â”‚  POST /api/child/login                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Request:  { username, password }                               â”‚ â”‚
â”‚  â”‚ Response: { success, child, token }                            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ â€¢ Validates credentials via Zod schema                         â”‚ â”‚
â”‚  â”‚ â€¢ Returns JWT token for subsequent requests                    â”‚ â”‚
â”‚  â”‚ â€¢ Token includes: child_id, therapist_id                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  CALIBRATION PERSISTENCE:                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GET /api/child/calibration                                     â”‚ â”‚
â”‚  â”‚   â†’ Returns existing calibration if child has one              â”‚ â”‚
â”‚  â”‚   â†’ { hasCalibration: true, calibration: {...} }               â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ POST /api/child/calibration                                    â”‚ â”‚
â”‚  â”‚   â†’ Saves calibration results (upsert)                         â”‚ â”‚
â”‚  â”‚   â†’ Skips calibration on future logins                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  MIDDLEWARE: authenticateChild                                       â”‚
â”‚  â€¢ Verifies JWT from Authorization header                           â”‚
â”‚  â€¢ Attaches req.child = { child_id, therapist_id }                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. SESSION START - GameplaySessionManager

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   GAMEPLAY SESSION MANAGER                           â”‚
â”‚                                                                      â”‚
â”‚  startGameplaySession(voiceSessionId, childId, categories, ...)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Get child info (therapist_id)                               â”‚ â”‚
â”‚  â”‚ 2. Abandon any existing in_progress sessions for child         â”‚ â”‚
â”‚  â”‚ 3. Create new session in database                              â”‚ â”‚
â”‚  â”‚ 4. Link voiceSessionId â†’ gameplaySessionId                     â”‚ â”‚
â”‚  â”‚ 5. Broadcast session_started to therapist                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  ACTIVE SESSION LINKS (in-memory Map):                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ voiceSessionId â†’ {                                             â”‚ â”‚
â”‚  â”‚   gameplaySessionId: number,                                   â”‚ â”‚
â”‚  â”‚   childId: number,                                             â”‚ â”‚
â”‚  â”‚   therapistId: number,                                         â”‚ â”‚
â”‚  â”‚   currentCardCategory?: string,                                â”‚ â”‚
â”‚  â”‚   currentCardQuestion?: string,                                â”‚ â”‚
â”‚  â”‚   currentCardStartTime?: number                                â”‚ â”‚
â”‚  â”‚ }                                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. TRACKING - Response Recording

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RESPONSE TRACKING                               â”‚
â”‚                                                                      â”‚
â”‚  onCardShown(voiceSessionId, cardContext)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ Updates link with current card info                          â”‚ â”‚
â”‚  â”‚ â€¢ Records card start time for duration tracking                â”‚ â”‚
â”‚  â”‚ â€¢ Broadcasts card_shown to therapist                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  onResponseProcessed(voiceSessionId, transcription, result)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ Calculates time spent on card                                â”‚ â”‚
â”‚  â”‚ â€¢ Records response in session_responses table:                 â”‚ â”‚
â”‚  â”‚   - cardCategory, cardQuestion, childResponse                  â”‚ â”‚
â”‚  â”‚   - isCorrect, attemptNumber, timeSpentSeconds                 â”‚ â”‚
â”‚  â”‚   - safetyLevel, signalsDetected                               â”‚ â”‚
â”‚  â”‚ â€¢ Updates session totals (score, cards_played, correct_count)  â”‚ â”‚
â”‚  â”‚ â€¢ Broadcasts child_response to therapist                       â”‚ â”‚
â”‚  â”‚ â€¢ If safetyLevel >= 2: broadcasts safety_alert                 â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ CARD CONTEXT HANDLING:                                         â”‚ â”‚
â”‚  â”‚ â€¢ Only clears card context when:                               â”‚ â”‚
â”‚  â”‚   - Answer is correct, OR                                      â”‚ â”‚
â”‚  â”‚   - SKIP_CARD intervention chosen                              â”‚ â”‚
â”‚  â”‚ â€¢ Preserves context on retries (attempt tracking)              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  onInterventionChosen(voiceSessionId, intervention)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â€¢ Updates most recent response with intervention_chosen        â”‚ â”‚
â”‚  â”‚ â€¢ Tracks: SKIP_CARD, RETRY_CARD, BUBBLE_BREATHING, etc.       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  SCORING (constants/game.ts):                                        â”‚
â”‚  â€¢ SCORE_CORRECT_ANSWER = 10                                        â”‚
â”‚  â€¢ SAFETY_ALERT_THRESHOLD = 2                                       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. BROADCAST - LiveSessionBroadcaster

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LIVE SESSION BROADCASTER                           â”‚
â”‚                                                                      â”‚
â”‚  SINGLETON: liveSessionBroadcaster                                   â”‚
â”‚                                                                      â”‚
â”‚  CONNECTIONS (in-memory Map):                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ therapistId â†’ Set<WebSocket>                                   â”‚ â”‚
â”‚  â”‚ (supports multiple browser tabs per therapist)                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  MESSAGE TYPES:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ session_started  â”‚ Child began playing                         â”‚ â”‚
â”‚  â”‚   â†’ { session: LiveSessionInfo }                               â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ card_shown       â”‚ New card displayed                          â”‚ â”‚
â”‚  â”‚   â†’ { sessionId, cardCategory, cardQuestion, cardShownAt }     â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ child_response   â”‚ Child answered                              â”‚ â”‚
â”‚  â”‚   â†’ { sessionId, childResponse, isCorrect, safetyLevel,        â”‚ â”‚
â”‚  â”‚       signalsDetected, responseAt, timeSpentSeconds }          â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ safety_alert     â”‚ Elevated safety level detected              â”‚ â”‚
â”‚  â”‚   â†’ { sessionId, safetyLevel, signals, timestamp }             â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ session_ended    â”‚ Game finished                               â”‚ â”‚
â”‚  â”‚   â†’ { sessionId, duration, totalCards, correctResponses,       â”‚ â”‚
â”‚  â”‚       accuracyPercent, finalScore, finalPosition, status }     â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ active_sessions  â”‚ List of current sessions (on connect)       â”‚ â”‚
â”‚  â”‚   â†’ { sessions: LiveSessionInfo[] }                            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ error            â”‚ Error message                               â”‚ â”‚
â”‚  â”‚   â†’ { message: string }                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  CLEANUP:                                                            â”‚
â”‚  â€¢ Auto-removes dead connections on broadcast                       â”‚
â”‚  â€¢ Unsubscribes on WebSocket close                                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. PERSISTENCE - Repository Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SESSION REPOSITORY                               â”‚
â”‚                                                                      â”‚
â”‚  CREATE:                                                             â”‚
â”‚  â€¢ createSession(childId, therapistId, categories, theme, char)     â”‚
â”‚                                                                      â”‚
â”‚  READ:                                                               â”‚
â”‚  â€¢ getSessionById(sessionId)                                        â”‚
â”‚  â€¢ getActiveSessionByChild(childId)                                 â”‚
â”‚  â€¢ getActiveSessionsForTherapist(therapistId)                       â”‚
â”‚  â€¢ getSessionHistoryByChild(childId, limit=20)                      â”‚
â”‚  â€¢ getSessionHistoryForTherapist(therapistId, limit=50)             â”‚
â”‚  â€¢ getSessionWithResponses(sessionId)                               â”‚
â”‚                                                                      â”‚
â”‚  UPDATE:                                                             â”‚
â”‚  â€¢ updateSessionProgress(id, score, position, cards, correct)       â”‚
â”‚  â€¢ endSession(id, status, finalScore, finalPosition)                â”‚
â”‚  â€¢ abandonActiveSessions(childId) â†’ abandons all in_progress        â”‚
â”‚                                                                      â”‚
â”‚  RESPONSES:                                                          â”‚
â”‚  â€¢ recordResponse(sessionId, data) â†’ creates response + updates     â”‚
â”‚  â€¢ getResponsesBySession(sessionId)                                 â”‚
â”‚  â€¢ updateLastResponseIntervention(sessionId, intervention)          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CALIBRATION REPOSITORY                             â”‚
â”‚                                                                      â”‚
â”‚  â€¢ getCalibrationByChildId(childId)                                 â”‚
â”‚  â€¢ saveCalibration(childId, data) â†’ upsert                          â”‚
â”‚  â€¢ deleteCalibration(childId)                                       â”‚
â”‚  â€¢ hasCalibration(childId)                                          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. THERAPIST LIVE VIEW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    THERAPIST LIVE VIEW                               â”‚
â”‚                                                                      â”‚
â”‚  WebSocket: /api/therapist/live                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ CLIENT MESSAGES:                                               â”‚ â”‚
â”‚  â”‚ â€¢ { type: 'subscribe' }        â†’ Start receiving updates       â”‚ â”‚
â”‚  â”‚ â€¢ { type: 'get_active_sessions' } â†’ Request current sessions   â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ SERVER MESSAGES:                                               â”‚ â”‚
â”‚  â”‚ â€¢ TherapistLiveMessage (see Â§4 MESSAGE TYPES)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  REST ENDPOINTS:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GET /api/session/therapist/active                              â”‚ â”‚
â”‚  â”‚   â†’ All active sessions for therapist's children               â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ GET /api/session/therapist/history?childId=X&limit=N           â”‚ â”‚
â”‚  â”‚   â†’ Past sessions (optionally filtered by child)               â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ GET /api/session/therapist/:id                                 â”‚ â”‚
â”‚  â”‚   â†’ Detailed session with all responses                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  FRONTEND UI (therapist.html):                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ LIVE SESSIONS PANEL:                                           â”‚ â”‚
â”‚  â”‚ â€¢ Shows active sessions with real-time updates                 â”‚ â”‚
â”‚  â”‚ â€¢ Displays: child name, current card, safety level indicator   â”‚ â”‚
â”‚  â”‚ â€¢ Click to expand detailed live view                           â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ SESSION HISTORY:                                                â”‚ â”‚
â”‚  â”‚ â€¢ List of past sessions with summary stats                     â”‚ â”‚
â”‚  â”‚ â€¢ Click for detailed session report                            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ SESSION DETAIL MODAL:                                           â”‚ â”‚
â”‚  â”‚ â€¢ Timeline of all cards played                                 â”‚ â”‚
â”‚  â”‚ â€¢ Each response: question, answer, correct/incorrect, time     â”‚ â”‚
â”‚  â”‚ â€¢ Intervention badges: â­ï¸ Skipped, ğŸ”„ Retry, ğŸ«§ Breathing      â”‚ â”‚
â”‚  â”‚ â€¢ Safety alerts highlighted                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. VALIDATION LAYER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ZOD VALIDATION                                  â”‚
â”‚                                                                      â”‚
â”‚  SCHEMAS (api/validation/schemas.ts):                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ LoginSchema                                                    â”‚ â”‚
â”‚  â”‚   { username: string, password: string }                       â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ CalibrationSchema                                              â”‚ â”‚
â”‚  â”‚   { amplitudeThreshold: 0-1, peakThreshold: 0-1,               â”‚ â”‚
â”‚  â”‚     baseline/excited/loud amplitude/peak, confidence }         â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ CreateSessionSchema                                            â”‚ â”‚
â”‚  â”‚   { categories: string[], theme?, character?, voiceSessionId? }â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ EndSessionSchema                                               â”‚ â”‚
â”‚  â”‚   { finalScore?, boardPosition?, status?, voiceSessionId? }    â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ RecordResponseSchema                                           â”‚ â”‚
â”‚  â”‚   { cardCategory, cardQuestion, childResponse, isCorrect,      â”‚ â”‚
â”‚  â”‚     attemptNumber?, timeSpentSeconds?, safetyLevel?,           â”‚ â”‚
â”‚  â”‚     signalsDetected? }                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  MIDDLEWARE (api/validation/middleware.ts):                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ validateBody(schema)                                           â”‚ â”‚
â”‚  â”‚   â€¢ Parses req.body with Zod schema                           â”‚ â”‚
â”‚  â”‚   â€¢ Returns 400 with field-level errors on failure             â”‚ â”‚
â”‚  â”‚   â€¢ Replaces req.body with parsed/transformed data             â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ validateQuery(schema)                                          â”‚ â”‚
â”‚  â”‚   â€¢ Same for req.query                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. COMPLETE DATA FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     COMPLETE SESSION FLOW                            â”‚
â”‚                                                                      â”‚
â”‚  CHILD LOGIN:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. POST /api/child/login                                       â”‚ â”‚
â”‚  â”‚ 2. GET /api/child/calibration â†’ check existing                 â”‚ â”‚
â”‚  â”‚ 3. If no calibration â†’ run calibration â†’ POST calibration      â”‚ â”‚
â”‚  â”‚ 4. If has calibration â†’ apply_calibration message via WS       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                       â”‚
â”‚  GAME START:                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Child selects categories, clicks PLAY                       â”‚ â”‚
â”‚  â”‚ 2. POST /api/session/start OR via voice session                â”‚ â”‚
â”‚  â”‚ 3. Manager: creates session, links voice session               â”‚ â”‚
â”‚  â”‚ 4. Broadcaster: session_started â†’ therapist                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                       â”‚
â”‚  GAMEPLAY LOOP:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ CARD SHOWN:                                                    â”‚ â”‚
â”‚  â”‚   VoiceSession.speakCard() â†’ Manager.onCardShown()             â”‚ â”‚
â”‚  â”‚   â†’ Broadcaster.broadcastCardShown() â†’ Therapist UI            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ CHILD RESPONSE:                                                â”‚ â”‚
â”‚  â”‚   SafetyGate processes â†’ Manager.onResponseProcessed()         â”‚ â”‚
â”‚  â”‚   â†’ Repository.recordResponse()                                â”‚ â”‚
â”‚  â”‚   â†’ Broadcaster.broadcastResponse() â†’ Therapist UI             â”‚ â”‚
â”‚  â”‚   â†’ If safetyLevel >= 2: broadcastSafetyAlert()               â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ INTERVENTION CHOSEN:                                           â”‚ â”‚
â”‚  â”‚   Child clicks option â†’ Manager.onInterventionChosen()         â”‚ â”‚
â”‚  â”‚   â†’ Repository.updateLastResponseIntervention()                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                       â”‚
â”‚  GAME END:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Child finishes OR disconnects OR therapist ends             â”‚ â”‚
â”‚  â”‚ 2. Manager.endGameplaySession(status: completed/abandoned)     â”‚ â”‚
â”‚  â”‚ 3. Repository.endSession() â†’ calculates duration               â”‚ â”‚
â”‚  â”‚ 4. Broadcaster.broadcastSessionEnd() â†’ Therapist UI            â”‚ â”‚
â”‚  â”‚ 5. Cleanup: remove voice session link                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## QUICK REFERENCE

### File Structure

| File | Purpose |
|------|---------|
| `services/session/index.ts` | Exports |
| `services/session/repository.ts` | Database CRUD |
| `services/session/manager.ts` | Session orchestration |
| `services/session/broadcaster.ts` | WebSocket broadcasts |
| `services/calibration/repository.ts` | Calibration persistence |
| `api/routes/child-auth.routes.ts` | Child login/calibration |
| `api/routes/session.routes.ts` | Session REST endpoints |
| `api/routes/therapist-live.routes.ts` | Therapist WebSocket |
| `api/validation/schemas.ts` | Zod validation schemas |
| `api/validation/middleware.ts` | Validation middleware |
| `api/middleware/childAuth.ts` | Child JWT middleware |
| `constants/game.ts` | Game constants |
| `types/session.ts` | TypeScript interfaces |

### Session Status Flow

```
in_progress â†’ completed (normal game end)
            â†’ abandoned (disconnect/timeout/manual)
```

### Safety Level Thresholds

| Level | Value | Broadcasts Alert |
|-------|-------|------------------|
| GREEN | 0 | No |
| YELLOW | 1 | No |
| ORANGE | 2+ | Yes |
| RED | 3 | Yes |

### Intervention Labels (Frontend)

| Value | Display |
|-------|---------|
| SKIP_CARD | â­ï¸ Skipped |
| RETRY_CARD | ğŸ”„ Retry |
| BUBBLE_BREATHING | ğŸ«§ Breathing |
| START_BREAK | â˜• Break |
| CALL_GROWNUP | ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Grownup |
